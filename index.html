<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
<title>dennisdebel</title>
<script src="./jquery.min.js"></script>

<script>
$(function(){
  let manifest = null;

  // ---------- Helpers: sort + pretty labels ----------
  function extractYear(name){
    const m = String(name).match(/^(\d{4})[-_ ]/);
    return m ? parseInt(m[1], 10) : null;
  }

  function prettyName(name){
    const str = String(name);

    // detect leading year
    const m = str.match(/^(\d{4})[-_ ]+(.*)$/);

    let year = null;
    let title = str;

    if (m) {
      year = m[1];
      title = m[2];
    }

    // normalize separators
    title = title
      .replace(/[_-]+/g, " ")
      .replace(/\s+/g, " ")
      .trim();

    // Title Case each word
    title = title.replace(/\b\w+/g, w =>
      w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()
    );

    return year ? `${title} (${year})` : title;
  }



  function isImage(file){
    return /\.(png|jpe?g|gif|webp)$/i.test(file);
  }

  function isVideo(file){
    return /\.(mp4|mov)$/i.test(file);
  }

  function sortedFolderKeys(section){
    const folders = manifest?.[section] || {};
    const keys = Object.keys(folders);

    return keys.sort((a, b) => {
      const ya = extractYear(a);
      const yb = extractYear(b);

      if (ya !== null && yb !== null) {
        if (ya !== yb) return yb - ya;     // newest first
        return a.localeCompare(b);
      }
      if (ya !== null && yb === null) return -1;
      if (ya === null && yb !== null) return 1;
      return a.localeCompare(b);
    });
  }

  function isSection(name){
    return !!manifest?.[name] && name !== "about"; // treat "about" separately
  }

  // ---------- Boot ----------
  createHeader();

  $.getJSON("manifest.json")
    .done(data => {
      manifest = data;
      routeFromURL();
      window.addEventListener("popstate", routeFromURL);
    })
    .fail(() => {
      $("#site-wrapper").html("<p style='color:red'>manifest.json not found</p>");
    });

  // ---------- Router (NOW SUPPORTS section-only permalinks) ----------
  function routeFromURL() {
    const params = new URLSearchParams(location.search);
    const section = params.get("section");
    const project = params.get("project");

    $(".project-back").remove();
    $("#site-wrapper").empty();

    // 1) Project permalink
    if (section && project && manifest?.[section]?.[project]) {
      setActive(section);
      renderProject(section, project);
      return;
    }

    // 2) Section permalink (e.g. ?section=activities)
    if (section && isSection(section)) {
      setActive(section);
      renderSectionGrid(section);
      return;
    }

    // 3) About permalink (e.g. ?section=about)
    if (section === "about") {
      setActive("about");
      renderAbout();
      return;
    }

    // 4) Home
    setActive("all");
    renderHomeFeatured();
  }

  function navigateTo(section, project) {
    const qs = (section && project)
      ? `?section=${encodeURIComponent(section)}&project=${encodeURIComponent(project)}`
      : (section ? `?section=${encodeURIComponent(section)}` : `./`);
    history.pushState({ section, project }, "", qs);
    routeFromURL();
  }

  // ---------- Header ----------
  function createHeader(){
    $("#global-header").html(`
      <span id='name'><a href='#' id='show-all'>dennis de bel</a></span>
      <span id='menu'>
        <a href='#' id='show-projects'>projects</a>
        <a href='#' id='show-publications'>publications</a>
        <a href='#' id='show-activities'>activities</a>
        <a href='#' id='show-about'>about</a>
      </span>
    `);

    // ✅ Now menu clicks set section permalinks (no flash)
    $(document)
      .off("click.nav")
      .on("click.nav", "#show-all", function(e){
        e.preventDefault();
        history.pushState({}, "", "./");
        routeFromURL();
      })
      .on("click.nav", "#show-projects", function(e){
        e.preventDefault();
        history.pushState({section:"projects"}, "", "?section=projects");
        routeFromURL();
      })
      .on("click.nav", "#show-publications", function(e){
        e.preventDefault();
        history.pushState({section:"publications"}, "", "?section=publications");
        routeFromURL();
      })
      .on("click.nav", "#show-activities", function(e){
        e.preventDefault();
        history.pushState({section:"activities"}, "", "?section=activities");
        routeFromURL();
      })
      .on("click.nav", "#show-about", function(e){
        e.preventDefault();
        history.pushState({section:"about"}, "", "?section=about");
        routeFromURL();
      });
  }

  function setActive(which){
    $("#menu a").removeClass("active");
    if(which === "projects") $("#show-projects").addClass("active");
    else if(which === "publications") $("#show-publications").addClass("active");
    else if(which === "activities") $("#show-activities").addClass("active");
    else if(which === "about") $("#show-about").addClass("active");
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  // ---------- Landing: Featured-only Home ----------
  function renderHomeFeatured(){
    $("#site-wrapper").html("<div class='content grid' style='display:none'></div>");
    const $grid = $("#site-wrapper .grid");

    const sectionOrder = ["projects", "publications", "activities"];
    const items = [];

    for (const section of sectionOrder){
      const folders = manifest?.[section];
      if(!folders) continue;

      for (const folder of Object.keys(folders)){
        const files = folders[folder];
        const featured = files.find(f => /featured\.(jpe?g)$/i.test(f));
        if (!featured) continue;

        items.push({
          section,
          folder,
          featured,
          year: extractYear(folder) ?? -1,
          key: folder
        });
      }
    }

    // newest year first, then name
    items.sort((a,b) => (b.year - a.year) || a.key.localeCompare(b.key));

    for (const it of items){
      $grid.append(`
        <div class='grid-item ${it.section}-item' data-section='${it.section}' data-folder='${it.folder}'>
          <a href='?section=${encodeURIComponent(it.section)}&project=${encodeURIComponent(it.folder)}' class='open-project'>
            <img src='${it.section}/${it.featured}' alt='${it.folder}'/>
          </a>
          <p class='desc'>${prettyName(it.folder)}</p>
        </div>
      `);
    }

    $grid.off("click.open").on("click.open", ".open-project", function(e){
      e.preventDefault();
      const parent = $(this).closest(".grid-item");
      navigateTo(parent.data("section"), parent.data("folder"));
    });

    $grid.fadeIn(250);
  }


  // ---------- Section Grid: show ALL items ----------
  function renderSectionGrid(section){
    $("#site-wrapper").html("<div class='content grid' style='display:none'></div>");
    const $grid = $("#site-wrapper .grid");

    const folders = manifest?.[section];
    if (!folders) {
      $grid.html(`<p style="padding:2rem">No "${section}" section found in manifest.</p>`);
      $grid.fadeIn(150);
      return;
    }

    for (const folder of sortedFolderKeys(section)){
      const files = folders[folder];
      const img = files.find(f => /\.(png|jpe?g|gif)$/i.test(f));
      if(!img) continue;

      $grid.append(`
        <div class='grid-item ${section}-item' data-section='${section}' data-folder='${folder}'>
          <a href='?section=${encodeURIComponent(section)}&project=${encodeURIComponent(folder)}' class='open-project'>
            <img src='${section}/${img}' alt='${folder}'/>
          </a>
          <p class='desc'>${prettyName(folder)}</p>
        </div>
      `);
    }

    $grid.off("click.open").on("click.open", ".open-project", function(e){
      e.preventDefault();
      const parent = $(this).closest(".grid-item");
      navigateTo(parent.data("section"), parent.data("folder"));
    });

    $grid.fadeIn(250);
  }

  // ---------- About View ----------
  function renderAbout(){
    $("#site-wrapper").html("<div class='content about-view' style='display:none'></div>");
    const $view = $("#site-wrapper .about-view");

    const aboutFiles = (manifest?.about?.["."]) || [];
    const txt = aboutFiles.find(f => /\.txt$/i.test(f));
    const img = aboutFiles.find(f => /\.(png|jpe?g|gif)$/i.test(f));

    if (img) {
      $view.append(`<div class='about-image'><img src='about/${img}' alt='about image'/></div>`);
    }
    if (txt) {
      $view.append(`<div class='about-text' data-file='about/${txt}'>Loading…</div>`);
      $.get(`about/${txt}`, t => {
        const $el = $view.find(".about-text");
        if (/\<[^>]+\>/.test(t)) $el.html(t);
        else $el.text(t);
      });
    } else {
      $view.append(`<div class='about-text'>No about.txt found.</div>`);
    }

    $view.fadeIn(250);
  }


  // ---------- Project View ----------
  function renderProject(section, folder){
    const files = manifest?.[section]?.[folder];
    if(!files){
      renderHomeFeatured();
      return;
    }

    $("#site-wrapper").html("<div class='content project-view' style='display:none'></div>");
    const $view = $("#site-wrapper .project-view");

    // Back button
    $("#global-header").after(`<div class='project-back'><a href='#' id='back-home'>← back</a></div>`);
    $("#back-home").off("click").on("click", function(e){
      e.preventDefault();
      history.pushState({}, "", "./");
      routeFromURL();
    });

    // ✅ Title at top (like grid caption)
    $view.append(`
      <div class="project-title">
        ${prettyName(folder)}
      </div>
    `);


    // Media (images + video, keep order from manifest)
    for(const f of files){
      if (isImage(f)) {
        $view.append(`
          <div class="project-media">
            <img src="${section}/${f}" alt="${folder}">
          </div>
        `);
      }
      else if (isVideo(f)) {
        $view.append(`
          <div class="project-media">
            <video controls playsinline preload="metadata">
              <source src="${section}/${f}">
              Your browser does not support the video tag.
            </video>
          </div>
        `);
      }
    }


    // Text (render HTML if it contains tags)
    for(const f of files){
      if(/\.txt$/i.test(f)){
        $view.append(`<div class='project-text' data-file='${section}/${f}'>Loading…</div>`);
      }
    }

    $view.find(".project-text").each(function(){
      const el = $(this);
      const file = el.data("file");
      $.get(file, t => {
        if (/\<[^>]+\>/.test(t)) el.html(t);
        else el.text(t);
      });
    });

    $view.fadeIn(250);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

});
</script>

<style>
@font-face {
  font-family:'yolo';
  src:url('./NimbusSanL-Reg.woff2') format('woff2'),
      url('./NimbusSanL-Reg.ttf') format('truetype');
}
body{font-family:"yolo";margin:0;padding:0;background:#fff;}

html, body {
  width: 100%;
}
*, *::before, *::after {
  box-sizing: border-box;
}
/* ensure text blocks never exceed viewport */
.about-text, .project-text {
  width: 100%;
  max-width: 600px;
  padding-left: 1rem;
  padding-right: 1rem;
  margin-left: auto;
  margin-right: auto;
  overflow-wrap: break-word;
  word-break: break-word;
}

a{color:black;text-decoration:none}
pre,address{display:none}

#global-header{
  position:sticky;
  top:0;
  background:white;
  z-index:999;
  padding:1rem 2rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
#menu a{cursor:pointer}
#menu a:hover{text-decoration:underline}
#menu a.active{text-decoration:underline;}
span#name{font-size:1.3rem}
span#menu{font-size:1.3rem; text-align:right;}

#back-home{display: none;}

#site-wrapper{
  width:100%;
  min-height:80vh;
  box-sizing:border-box;

  /* iOS friendly: no flex centering */
  display:block;
  padding: 0 1rem;
}

.content.about-view,
.content.project-view{
  width:100%;
  max-width:800px;
  margin:0 auto;
  padding: 1rem 0;
  box-sizing:border-box;
}


.content.grid{
  max-width:1200px;
  width:100%;
  margin:0 auto;
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  align-content:flex-start;
  gap:1.25rem;
  padding:2rem 1rem;
  box-sizing:border-box;
}

.project-title{
  max-width: 800px;
  margin: 0 auto 1rem auto;
  padding: 9rem 1rem 9rem; /* top | sides | bottom */
  font-size: 3rem;
  line-height: 1.3;
  text-align: center;
}

.grid-item{
  display:flex;
  flex-direction:column;
  align-items:center;
  flex:0 1 clamp(260px, 40vw, 520px);
  box-sizing:border-box;
}
.grid-item .desc{
  margin-top:0.5rem;
  text-align:center;
  font-size:0.9rem;
  line-height:1.2;
}
.grid-item img{
  width:100%;
  object-fit:cover;
  border-radius:4px;
  transition:transform .3s ease;
}
.grid-item img:hover{transform:scale(1.02)}

.project-view img{
  width:100%;
  max-width:800px;
  margin:auto;
  display:block;
  padding-bottom:1rem;
  opacity:0;
  animation:fadeIn .5s forwards;
}
@keyframes fadeIn{to{opacity:1;}}

.project-text,.about-text{
  max-width:600px;
  line-height:1.5em;
  padding:1em;
  margin:auto;
  opacity:0;
  animation:fadeIn .8s forwards;
  color: black;
  font-family: Helvetica, Arial, sans-serif;
  font-size: 16px;
  line-height: 20px;
  letter-spacing: .2px;
}

.project-text a, .about-text a{ 
  text-decoration: none;          /* remove default underline */
  border-bottom: 2px solid #000;  /* your custom underline */
  display: inline;
  padding-bottom: 0px;
}

.project-text a:hover, .about-text a:hover{
  border-bottom-color: rgba(0,0,0,0.6);
}

.project-media{
  width:100%;
  max-width:800px;
  margin:0 auto 1rem auto;
}

.project-media img,
.project-media video{
  width:100%;
  display:block;
  border-radius:4px;
}

.project-media video{
  background:#000;
}


.about-image img{max-width:400px;width:100%;}

.project-back{padding:0.5em 2rem;font-size:1rem;}

#global-footer{width:100%;padding:2rem;background:white;box-sizing:border-box;}

@media (max-width:800px){
  .content.grid{padding:1rem;gap:0.75rem;}
  .grid-item{flex:0 1 100%;max-width:36rem;}
  #global-header{padding:1rem}
}
</style>
</head>

<body>
  <div id="global-header"></div>
  <main id="site-wrapper"></main>
  <footer id="global-footer"></footer>
</body>
</html>
