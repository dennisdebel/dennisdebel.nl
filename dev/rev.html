<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Engine Throttle (Coil-Driven)</title>
<style>
:root{color-scheme:dark}
body{margin:0;font-family:system-ui;background:#0b0f14;color:#e9eef5}
.wrap{max-width:960px;margin:auto;padding:16px}
.card{background:#121a24;border:1px solid #1f2b3a;border-radius:14px;padding:14px}
.muted{color:#9fb0c6;font-size:13px}
.big{font-size:32px;font-weight:800}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="big">Engine</div>
    <p class="muted" id="status">connectingâ€¦</p>
    <button id="prime">Enable Audio</button>
  </div>
</div>

<script>
(() => {
  /* ================= CONFIG ================= */

  const RELAY = "recoil-d002.onrender.com";
  const ROOM  = "motor";

  const COIL_IDLE = 1.50;
  const COIL_FULL = 2.10;

  const PITCH_MIN = 1.00;
  const PITCH_MAX = 1.28;

  const COIL_SMOOTH = 0.10;

  /* ================= AUDIO ================= */

  let ctx=null, master=null;
  let idleBuf=null, revBuf=null;
  let idleSrc=null, revSrc=null;
  let idleGain=null, revGain=null;

  let coilValue = COIL_IDLE;
  let coilSmooth = COIL_IDLE;
  let lastRate = 1.0;

  const status = document.getElementById("status");
  const prime  = document.getElementById("prime");

  function kill(src){ if(src){ try{src.stop();src.disconnect();}catch(e){} } }

  function fade(param,val,ms){
    const t=ctx.currentTime;
    param.cancelScheduledValues(t);
    param.setValueAtTime(param.value,t);
    param.linearRampToValueAtTime(val,t+ms/1000);
  }

  async function load(url){
    const r=await fetch(url);
    return ctx.decodeAudioData(await r.arrayBuffer());
  }

  async function ensureAudio(){
    if(!ctx){
      ctx=new AudioContext();
      master=ctx.createGain();
      master.gain.value=0.9;
      master.connect(ctx.destination);
    }
    if(ctx.state!=="running") await ctx.resume();
    if(!idleBuf){
      idleBuf=await load("idling.wav");
      revBuf =await load("rev.wav");
      startIdle(true,1.0);
    }
  }

  function startIdle(immediate=false,startRate=1.0){
    kill(idleSrc);
    idleSrc=ctx.createBufferSource();
    idleGain=ctx.createGain();
    idleSrc.buffer=idleBuf;
    idleSrc.loop=true;
    idleSrc.playbackRate.value=startRate;
    idleGain.gain.value=immediate?1:0;
    idleSrc.connect(idleGain).connect(master);
    idleSrc.start();
    if(!immediate) fade(idleGain.gain,1,400);
  }

  function startRev(){
    kill(revSrc);
    revSrc=ctx.createBufferSource();
    revGain=ctx.createGain();
    revSrc.buffer=revBuf;
    revSrc.loop=true;
    revGain.gain.value=1;
    revSrc.connect(revGain).connect(master);
    revSrc.start();
  }

  /* ================= RELAY ================= */

  function connectRelay(){
    const url = `wss://${RELAY}/ws?room=motor&role=client`;
    const ws = new WebSocket(url);

    ws.onopen  = ()=>status.textContent="connected";
    ws.onclose = ()=>status.textContent="disconnected";
    ws.onerror = ()=>status.textContent="error";

    ws.onmessage = (ev)=>{
      const s=(""+ev.data).trim();
      const m=s.match(/rate=([0-9.]+)/);
      if(m) coilValue=parseFloat(m[1]);
    };
  }

  /* ================= LOOP ================= */

  function tick(){
    coilSmooth += (coilValue - coilSmooth) * COIL_SMOOTH;

    let x = (coilSmooth - COIL_IDLE) / (COIL_FULL - COIL_IDLE);
    x = Math.max(0, Math.min(1, x));

    const rate = PITCH_MIN + x * (PITCH_MAX - PITCH_MIN);
    lastRate = rate;

    if(revSrc){
      revSrc.playbackRate.setTargetAtTime(rate,ctx.currentTime,0.08);
    }

    // simple state
    if(x > 0.03){
      if(!revSrc){ kill(idleSrc); startRev(); }
    }else{
      if(!idleSrc){ kill(revSrc); startIdle(false,lastRate); }
    }

    requestAnimationFrame(tick);
  }

  prime.onclick = async()=>{
    await ensureAudio();
    connectRelay();
    requestAnimationFrame(tick);
  };
})();
</script>
</body>
</html>
